develop_code_task:
  description: >
    Você é um Desenvolvedor Senior. Gere o código Python para um dashboard Streamlit.
    
    Dados: {data_summary}
    Pedido do Usuário: {user_request}
    Arquivo: '{file_path}'
    
    REGRAS DE CODIFICAÇÃO:
    1. Crie filtros interativos (st.multiselect) para colunas categóricas.
    2. Crie 2 ou 3 gráficos Altair interessantes (ex: Temporal e Categórico).
    3. Use 'pd.read_csv(r"{file_path}")'.
    4. NÃO use '@st.cache' ou 'st.set_page_config'.
    5. NÃO explique nada, apenas gere o código.
    6. MAPAS: Se houver 'Latitude' e 'Longitude', use este código de limpeza:
       df_map = df_filtered.copy()
       def clean_coord(x):
           if pd.isna(x): return x
           s = str(x).replace(',', '').strip()
           # Remove todos os pontos, exceto o primeiro
           if s.count('.') > 1:
               parts = s.split('.')
               s = parts[0] + '.' + ''.join(parts[1:])
           return pd.to_numeric(s, errors='coerce')

       df_map['lat'] = df_map['Latitude'].apply(clean_coord)
       df_map['lon'] = df_map['Longitude'].apply(clean_coord)
       st.map(df_map.dropna(subset=['lat', 'lon'])[['lat', 'lon']])
    7. IDIOMA: Todo o texto visível (títulos, eixos, tooltips) DEVE estar em PORTUGUÊS DO BRASIL.
    8. ZOOM: Adicione '.interactive()' em TODOS os gráficos Altair.
    9. COR: Sempre que possível, use 'color' para diferenciar categorias.
  expected_output: >
    Apenas o código Python válido.

create_narrative_task:
  description: >
    Você é um Arquiteto de Dados.
    ANALISE O CÓDIGO PYTHON GERADO PELA TAREFA ANTERIOR.
    
    Com base nos gráficos que o desenvolvedor criou no código, gere o relatório da Gramática dos Gráficos.
    
    ESTRUTURA DA ANÁLISE (Markdown):
    **1. Dados:** Quais colunas foram usadas no código?
    **2. Transformações:** O código faz filtros ou agrupa dados?
    **3. Mapeamentos:** O que está no eixo X, Y e Cor (encode)?
    **4. Marcas:** Qual 'mark_' foi usado (bar, line, circle)?
    **5. Avaliação:** O gráfico escolhido faz sentido para os dados?

    ---
    REGRAS DE SAÍDA CRÍTICAS (MONTAGEM FINAL):
    Você deve retornar UMA única string combinando sua análise e o código original.
    
    Formato:
    [Sua Análise da Gramática dos Gráficos em Português]
    |||SEP|||
    [O CÓDIGO PYTHON ORIGINAL QUE VOCÊ RECEBEU DO CONTEXTO]
    
    IMPORTANTE: Você PRECISA copiar e colar o código Python exato que recebeu da tarefa anterior após o separador.
  expected_output: >
    Análise Gramatical |||SEP||| Código Python Original.

append_chart_task:
  description: >
    Você é um Especialista em Manutenção de Código Python/Streamlit.
    
    INPUTS:
    1. Código Atual: {current_code}
    2. Pedido (Novo Gráfico): {user_request}
    
    OBJETIVO:
    Adicione o novo gráfico ao código existente SEM remover nada do que já está lá.
    
    REGRAS DE ENGENHARIA:
    1. Analise o código atual e descubra qual é o nome da variável do DataFrame filtrado (geralmente 'df_filtered' ou similar). Use ELA para o novo gráfico.
    2. NÃO crie novos filtros se eles já existirem na sidebar.
    3. Adicione o novo gráfico no final do script, dentro de um 'st.expander' ou container.
    4. IDIOMA: Títulos e eixos em Português do Brasil.
    5. ZOOM: Adicione '.interactive()' no novo gráfico.
    6. Mantenha todos os imports originais.
    
    SAÍDA:
    Retorne APENAS o Código Python COMPLETO e ATUALIZADO.
  expected_output: >
    Apenas o Código Python Completo.

calculate_metrics_task:
  description: >
    Você é um Analista de Dados Sênior.
    
    Dados: {data_summary}
    Pedido: {user_request}
    
    OBJETIVO:
    Calcular e explicar os números mais importantes solicitados.
    NÃO gere código Python ou gráficos.
    Gere um RESUMO EXECUTIVO em texto (Markdown).
    
    FORMATO DE SAÍDA:
    Use markdown para destacar os números. Exemplo:
    "**Média de Potência:** 150cv"
    "**Carro mais potente:** Ferrari (800cv)"
    
    Seja direto e use bullet points.
  expected_output: >
    Texto em Markdown com os destaques numéricos.

complex_viz_task:
  description: >
    Você é um Especialista em Visualização de Dados Avançada (Vega-Altair Master).
    
    Dados: {data_summary}
    Pedido: {user_request}
    Arquivo: '{file_path}'
    
    O usuário pediu uma visualização COMPLEXA (ex: camadas, arcos, duplo eixo).
    1. Consulte a tool de RAG 'complex_viz_rag' para buscar inspirações de código.
    2. Projete uma visualização usando 'alt.layer()', 'alt.vconcat()' ou 'alt.hconcat()'.
    3. Combine marcas (ex: Barra + Linha de Média, ou Scatter + Regressão).
    
    SAÍDA:
    Código Python completo do dashboard complexo.
  expected_output: >
    Código Python Complexo.

geo_viz_task:
  description: >
    Você é um Especialista em Geoprocessamento.
    Gere código Streamlit que utilize 'st.pydeck_chart' para visualizações 3D 
    ou 'alt.Chart' com dados geográficos (topojson).
    Requisito: O DataFrame deve possuir colunas de localização.
  expected_output: >
    Código Python com visualização de mapa avançada.